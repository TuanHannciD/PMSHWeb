<style>
    .tabs-container {
        max-width: 60%;
    }

    .dx-tab-form {
        display: none;
    }

    .dx-visible {
        display: block;
    }

    .mui-card {
        width: 30% !important;
    }
</style>
<div class="text-center" id="reportTitle" style="font-size: 20px">Package</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnView" onclick="openModalSearchUser()"
            class="mui-button mui-button-search"><i class="fa-solid fa-search"></i>Search</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnNew" class="mui-button mui-button-new"
            type="button"> <i class="fa-solid fa-file-excel"></i> New</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnEdit" class="mui-button mui-button-edit "
            type="button"> <i class="fa-solid fa-file-excel"></i> Edit</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnDelete" class="mui-button button-report-delete"
            type="button"> <i class="fa-solid fa-file-excel"></i> Delete</button>
    </div>
</div>
<div class="mui-card"></div>

<div class="dx-tab-form" data-tab="1">
    <div class="row">
        <!-- LEFT FORM -->
        <div class="col-md-4">
            <div class="row g-2">

                <div class="col-12">
                    <label class="form-label me-2 mb-0">Season Code</label>
                    <input type="text" class="form-control mb-2">
                </div>

                <div class="col-6">
                    <label class="form-label me-2 mb-0">Start Date</label>
                    <input type="date" class="form-control mb-2">
                </div>

                <div class="col-6">
                    <label class="form-label me-2 mb-0">End Date</label>
                    <input type="date" class="form-control mb-2">
                </div>

                <div class="col-12">
                    <label class="form-label me-2 mb-0">Trans. Code</label>
                    <div class="input-group">
                        <input type="text" class="form-control mb-2">
                        <button class="btn btn-outline-secondary">...</button>
                    </div>
                </div>

                <div class="col-12">
                    <label class="form-label me-2 mb-0">Currency</label>
                    <select class="form-select" mb-2>
                        <option></option>
                    </select>
                </div>

                <div class="col-12">
                    <label class="form-label me-2 mb-0">Price ++</label>
                    <input type="number" class="form-control mb-2">
                </div>

                <div class="col-12">
                    <label class="form-label me-2 mb-0">Price Net</label>
                    <input type="number" class="form-control mb-2">
                </div>

                <div class="col-12">
                    <label class="form-label me-2 mb-0">Allowance</label>
                    <input type="number" class="form-control mb-2">
                </div>

                <div class="col-12">
                    <label class="form-label me-2 mb-0">Posting Rhythm</label>
                    <select class="form-select mb-2">
                        <option></option>
                    </select>
                </div>

                <div class="col-12">
                    <label class="form-label me-2 mb-0">Calculation Rule</label>
                    <select class="form-select mb-2">
                        <option></option>
                    </select>
                </div>
            </div>

            <!-- Buttons -->
            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-secondary">Clear</button>
                <button class="btn btn-primary">Add</button>
                <button class="btn btn-danger">Remove</button>
            </div>
        </div>

        <!-- RIGHT TABLE -->
        <div class="col-md-8">
            <div class="table-responsive border">
                <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Trans. Code</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Price After Tax</th>
                            <th>Currency</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                No data
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<div class="dx-tab-form dx-visible" data-tab="0">
    <div class="tabs-container border p-3 mt-3 mx-auto">

        <!-- Thông tin chính -->
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label" id="code">Code</label>
                <input type="text" class="form-control mb-2">
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <div class="w-100">
                    <label class="form-label">Forecast Group</label>
                    <select class="form-control form-select form-control-sm" id="forecastGroup">
                        <option value="0">-- Select Forecast Group -- </option>
                        @foreach (dynamic u in ViewBag.PackageForecastGroup)
                        {
                            <option value="@u.ID">@u.Code / @u.Name</option>
                        }
                    </select>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label">Type</label>
                <select class="form-control form-select form-control-sm" disabled>
                    <option value="0">Element</option>
                </select>
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <div class="w-100">
                    <label class="form-label">Transaction Code</label>
                    <div class="input-group">
                        <input type="text" class="form-control">
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <input type="text" class="form-control">
            </div>

            <div class="mb-3">
                <label class="form-label">Display in Folio</label>
                <input type="text" class="form-control">
            </div>

            <div class="checkbox">
                <input class="form-check-input" type="checkbox" id="active" checked>
                <label class="form-check-label" for="active">Active</label>
            </div>

            <!-- Attributes + Meal Info -->
            <div class="row g-3 mt-3">
                <!-- Attributes -->
                <div class="col-md-6 border p-3">
                    <label for="">Default Display</label>
                    <div class="group-box">
                        <label><input type="radio" name="attr" value="1" id="included" checked>
                            Included In Rate</label><br />
                        <label><input type="radio" name="attr" value="0" id="separate">
                            Add Rate Separate Line</label><br />
                    </div>
                </div>

                <!-- Meal Info -->
                <div class="col-md-6 border p-3">
                    <label class="form-label fw-bold">Meal Info</label><br>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="breakfast" checked>
                        <label class="form-check-label" for="breakfast">Breakfast</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="lunch" checked>
                        <label class="form-check-label" for="lunch">Lunch</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="dinner" checked>
                        <label class="form-check-label" for="dinner">Dinner</label>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div class="modal fade modal-md mt-2 modal-search" id="modalSearch" tabindex="-1" style="height: 80%;">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Search User</h5>
                <button type="button" class="btn-close" onclick="closeModalSearchUser()"></button>
            </div>

            <div class="modal-body">

                <div class="row mb-2">
                    <div class="col-md-4">
                        <label>Search</label>
                        <input type="text" id="packageSearch" class="form-control" placeholder="Enter User name"
                            onkeyup="filterUserList()" />
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th style="width:120px">Code</th>
                                <th>Job Description</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            @foreach (var u in ViewBag.PackageList)
                            {
                                <tr onclick="selectPackage('@u.ID')" style="cursor:pointer">
                                    <td>@u.Code</td>
                                    <td>@u.Description</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>

        </div>
    </div>
</div>
<script>
    const tabsText = [
        { text: 'Package Header' },
        { text: 'Package Detail' },

    ];

    $('.mui-card').dxTabs({
        dataSource: tabsText,
        selectedIndex: 0,
        keyExpr: 'text',       // dùng text làm key duy nhất
        width: '60%',
        showNavButtons: false,
        stylingMode: 'text',

        onSelectionChanged: function (e) {
            // Ẩn tất cả form
            $('.dx-tab-form').hide();

            // Hiện form tương ứng
            const formToShow = $('.dx-tab-form[data-tab="' + e.component.option('selectedIndex') + '"]');
            formToShow.show();
        }
    }).dxTabs('instance');

    function setFormReadOnly(readOnly = true) {
        // Tất cả input, textarea, select ngoại trừ select Type
        $('.dx-tab-form input, .dx-tab-form textarea, .dx-tab-form ,#forecastGroup').not('select,.modal-search').prop('disabled', readOnly);

        // Checkbox và radio
        $('.dx-tab-form input[type=checkbox], .dx-tab-form input[type=radio]').prop('disabled', readOnly);

        // Nếu muốn select Type luôn disabled:
        //        $('select').prop('disabled', true);
    }
    function clearFormData() {
        // Xóa giá trị các input text, textarea
        $('.dx-tab-form input[type="text"], .dx-tab-form textarea').val('');

        // Reset các select về giá trị mặc định (thường là option đầu tiên)
        $('.dx-tab-form select').each(function () {
            this.selectedIndex = 0;
        });

        // Reset checkbox/radio về mặc định (checked hay không tuỳ theo HTML ban đầu)
        $('.dx-tab-form input[type="checkbox"], .dx-tab-form input[type="radio"]').each(function () {
            this.checked = $(this).prop('defaultChecked');
        });
    }
    // Khi load page, form chỉ đọc
    setFormReadOnly(true);
    $('#btnNew').on('click', function () {
        clearFormData();
        setFormReadOnly(false);  // Bỏ disabled
    });

    // sử lý modal
    function openModalSearchUser() {
        $('#modalSearch').modal('show');
    }

    function closeModalSearchUser() {
        $('#packageSearch').val('');
        filterUserList();
        $('#modalSearch').modal('hide');
    }

    function selectPackage(id) {
        $.ajax({
            url: '/Administration/RateCode/GetByIDPackage',
            type: 'GET',
            data: { id: id },
            success: function (res) {
                console.log('API RES:', res);
                $('#idUserName').val(id);
                $('#txtUserName').val(name);      // gán ra form chính
                $('#modalSearch').modal('hide');
            },
            error: function () {
                alert("Không thể tải dữ liệu");
                $("#loadingSpinner").hide();
            }
        })

    }

    function filterUserList() {
        let keyword = $('#packageSearch').val().toLowerCase();

        $('#userTableBody tr').each(function () {
            let text = $(this).text().toLowerCase();
            $(this).toggle(text.includes(keyword));
        });
    }

</script>
